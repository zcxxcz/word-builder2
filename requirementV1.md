# 初一背单词 Web App 需求文档（PRD）V2

## 1. 文档信息
- 文档名称：初一背单词 Web App（外研版 + 自定义）PRD
- 版本：V2.0（基于 V1 讨论后更新）
- 日期：2026-02-27
- 负责人：胖猴
- 评审人：三叶虫

---

## 2. 背景与目标

### 2.1 背景
初一阶段词汇增长快，常见问题：
- 背了就忘，复习节奏不稳定
- 认识意思与拼写能力脱节
- 练习形式枯燥导致坚持难

### 2.2 产品目标
- 通过"回想（检索）+ 拼写（输出）"的高效练习机制，让孩子在可持续节奏下掌握并保持词汇。
- 提供外研版新课标初一内置词表，同时支持家长/孩子自定义扩展。

### 2.3 成功标准（MVP）
- 7日留存率、每日完成率（计划任务完成）
- 拼写正确率提升（周维度）
- 掌握词数增长（L3 数量增长）
- 错词回流后纠正率（当天回流纠正比例）

---

## 3. 用户与使用场景

### 3.1 目标用户
- 学生（初一，12–13岁）：需要短时高频、强反馈、低挫败的学习体验
- 家长：主要诉求是词表可控、可加词、学习可视化（V1 不做家长端，先通过战报/导出替代）

### 3.2 核心场景
- 每天晚饭后/睡前 10–15 分钟：完成"到期复习 + 新词学习"
- 老师/家长临时加词：只输入英文 → DeepSeek AI 自动生成释义/音标/例句 → 稍作编辑 → 加入词表

---

## 4. 产品范围与约束

### 4.1 V1 必做（P0）
1. **词表**：
   - 内置：外研版新课标初一词汇（按册/单元组织），存储于 Supabase 共享表
   - 自定义：手动添加生词（通过 DeepSeek AI 自动生成释义）
2. **计划与任务**：
   - 每日新学 N + SRS 到期复习 + 当天错词回流
3. **练习形式（无选择题）**：
   - 意思训练：回想 → 显示答案 → 自评
   - 拼写训练：直接打字 → 判对错 → 错则强制纠正
4. **生词"智能生成"（只输英文）**：
   - 采用 DeepSeek API 生成中文释义、音标、例句
   - 发音兜底：Web Speech API TTS
5. **学习战报与进度统计**
6. **用户认证与云存储**：
   - 强制登录（Supabase Auth，支持邮箱/密码）
   - 所有数据实时存储于 Supabase（PostgreSQL），支持多设备同步

### 4.2 V1 明确不做
- 任何形式的选择题（意思/拼写均不提供选项）
- 社交、排行榜、广告
- 老师端/班级端、家长端（后续版本）

---

## 5. 技术架构

### 5.1 技术选型
| 层面 | 技术 |
|------|------|
| 前端框架 | Vite + React 18 |
| 路由 | React Router v6 |
| 状态管理 | Zustand |
| 样式 | Vanilla CSS + CSS Variables（支持暗色模式） |
| 后端 / 数据库 | Supabase（Auth + PostgreSQL） |
| AI 生词生成 | DeepSeek API（deepseek-chat 模型） |
| 发音 | Web Speech API TTS（免费，无外部依赖） |

### 5.2 数据存储方案
- **云优先**：所有数据存储于 Supabase PostgreSQL，通过 RLS 实现数据隔离
- **多设备同步**：同一账号在不同设备登录后数据一致
- **离线不支持**：需联网使用，断网时操作将失败（显示错误提示）

### 5.3 DeepSeek API 保护
- **开发/个人使用**：API Key 存储在前端环境变量（`.env`）中直接调用
- **公开部署时**：切换为 Supabase Edge Function 代理（代码已准备在 `supabase/functions/deepseek-proxy/`）
- **限流**：每用户每日 AI 生成上限 30 次，通过 localStorage 计数

---

## 6. 产品形态（Web）
- 浏览器访问（移动端优先，兼容 PC）
- 支持内网通过手机访问（dev server 默认开启 `--host`）

---

## 7. 信息架构（IA）
底部 Tab Bar（移动端优先，学习中隐藏）：
1. **今日** — 任务概览 + 开始入口
2. **词表** — 内置 / 自定义词表浏览与管理
3. **进度** — 学习统计 + 等级分布
4. **我的** — 设置 / 导出 / 账号

> 注：学习页为沉浸式全屏，不显示底部 Tab Bar。

---

## 8. 核心业务规则

### 8.1 记忆等级（SRS）
- L0 陌生
- L1 认识
- L2 熟练
- L3 掌握

### 8.2 复习间隔（简化版）
按最终等级设置 next_review：
- L0：+1 天
- L1：+2 天
- L2：+5 天
- L3：+10 天

（后续可扩展为 20/30/60）

### 8.3 每日任务生成
参数：
- daily_new（默认 10）
- review_cap（默认 40）
- relapse_cap（默认 10）

队列构成（固定顺序）：
1. **到期复习**：next_review ≤ today，最多 review_cap
2. **新学**：从未学过的词中取 daily_new
3. **新词自动复习**：新学完成后，对所有新学的词自动发起一轮复习，体验与到期复习一致
4. **当天回流**：当日拼写错误 / 意思自评"不认识"的词，最多 relapse_cap

### 8.4 单词学习流程

#### 新词学习
每词固定依次完成 Step A（回想）→ Step B（拼写），然后进入下一词。

#### 复习流程（到期复习 / 新词自动复习 / 回流）
对所有复习的单词以**随机顺序**：
1. 先全部走一遍 Step A（回想）
2. 再全部走一遍 Step B（拼写）

> **新词自动复习**：新学完成后自动开启的复习，体验与"到期复习"完全一致。

#### Step A：意思回想（无选项）
- 展示英文 + 自动 TTS 发音（可关闭）
- 提示先回想中文 → 点击"显示答案"
- 显示中文释义后，学生自评（自评按钮非选项题）：
  - ✅ 我想对了（认识）
  - ❌ 没想出来（不认识）

#### Step B：拼写打字（无选项）
- 展示中文释义 + 可选发音按钮
- 输入英文 → 提交判定
- 错误：显示正确拼写，并要求至少再输入一次正确拼写（强化纠正）

以上所有步骤支持在电脑上按 **Enter** 进入下一步。

### 8.5 等级更新规则（结合自评 + 拼写）

- **升级条件**：复习中意思回想和拼写打字**两项均通过**时，等级 +1（含新学完成后的自动复习）
- **降级条件**：任一项未通过，等级 -1（最低 L0），该词加入当天回流队列
- **仅学习不升级**：首次新学过程中的 Step A/B 不影响等级

### 8.6 同词判定规则
- **同一个 word 字符串视为同一个词**（不区分词表来源）
- 不同词表中出现相同英文时，共享同一份学习状态（`user_word_state`）
- 生成每日队列时，相同 word 自动去重，**随机选择一个词表来源**的释义展示

---

## 9. 功能需求（模块拆解）

### 9.1 词表模块（P0）

#### 9.1.1 内置外研版词表
- 支持按：册（上/下）→ 单元 → 词
- 每词字段：
  - word（英文）
  - meaning_cn（中文释义，支持多义 `;` 分隔）
  - unit（单元）
  - phonetic（可选）
  - example（例句，可选）

#### 9.1.2 自定义词表管理
- 创建自定义词表（名称）
- 手动添加词（见 9.2 智能生词生成）
- CSV 导入：
  - 上传 CSV → 解析 → 预览 → 导入为新词表
  - 必须列：word
  - 可选列：meaning_cn, unit, example, phonetic

### 9.2 智能生词生成（只输入英文）（P0）

#### 9.2.1 需求描述
用户在添加生词时只输入英文单词，程序通过 DeepSeek API 自动生成：
- 中文释义（初中可接受难度）
- 音标（IPA）
- 例句（1–2句，初中难度）

生成后，用户可编辑所有字段再保存。

#### 9.2.2 生成规则（硬约束）
- 中文释义：
  - 每条 ≤ 12 个汉字
  - 最多 3 条义项（`;` 分隔）
  - 避免生僻翻译与学术表达
- 例句：
  - 1–2 句
  - 句长 6–12 个词
  - 不使用复杂从句结构
  - 必须包含目标词（优先原形）
- 失败兜底：
  - 生成失败时仍展示可编辑表单，用户可手动填写后保存

#### 9.2.3 页面交互（添加生词）
- 输入英文 → 点击"✨ 生成"
- 生成完成展示可编辑表单：word、meaning_cn、phonetic、example
- 保存到"生词本"（默认自定义词表，自动创建）

#### 9.2.4 限流策略
- 每用户每日 AI 生成上限 **30 次**
- 超限后提示"明天再试或手动填写"
- 计数通过 localStorage 实现（开发阶段）；公开部署时可切换为 Edge Function 服务端计数

### 9.3 学习模块（P0）

#### 9.3.1 今日页（任务入口）
- 展示：待复习数量、新学数量、预计时长
- 入口：开始学习（复习 → 新学 → 新词自动复习 → 回流）
- 今日完成后：展示战报摘要（新学/复习/正确率/升级数/最难词）
- 底部展示已学词数 / 总词数

#### 9.3.2 学习页（沉浸式）
- 顶部：退出按钮、当前阶段标签（复习/新学/回流）、进度（x/y）、进度条
- 内容：
  - Step A 意思回想卡：
    - 英文 + 自动 TTS 发音
    - "点击显示答案"按钮
    - 自评两按钮（✅ 想对了 / ❌ 没想出来）
  - Step B 拼写卡：
    - 中文释义 + 发音按钮
    - 输入框 + 提交（Enter 或按钮）
    - 对错反馈 + 错误纠正（至少输入一次正确）
- 错词回流：
  - 当天错的词加入回流队列，学习末尾出现（最多 relapse_cap）
- 完成战报：
  - 新学数、复习数、拼写正确率、升级词数、学习时长、最难词

### 9.4 进度与数据（P0）

#### 9.4.1 进度页
- 累计：学过词数、掌握词数（L3）
- 本周：学习天数
- 等级分布条形图：L0/L1/L2/L3
- 最近学习记录列表（最近 10 次）

#### 9.4.2 完成战报
- 今日完成：新学数、复习数、拼写正确率、升级词数、学习时长、最难词（错最多）

### 9.5 我的/设置（P0）
- 显示当前登录用户邮箱
- 学习设置：
  - 每日新学量 daily_new（滑块，3–30）
  - 复习上限 review_cap（滑块，10–100）
  - 回流上限 relapse_cap（滑块，3–20）
- 发音设置：
  - TTS 开关
  - 语速调节（0.5×–2.0×）
- 数据管理：
  - 导出数据（JSON）
  - 导入数据（JSON）
  - 清空所有数据（双重确认）
- 退出登录

---

## 10. 数据结构

### 10.1 数据库表（Supabase PostgreSQL）

| 表名 | 用途 | 关键字段 |
|------|------|---------|
| `built_in_wordlists` | 内置词表（共享只读） | id, name, description |
| `built_in_words` | 内置词汇 | id, wordlist_id, word, meaning_cn, unit, phonetic, example |
| `custom_wordlists` | 自定义词表（用户级） | id, user_id, name, description |
| `custom_words` | 自定义词汇（用户级） | id, user_id, wordlist_id, word, meaning_cn, phonetic, example |
| `user_word_state` | 学习进度（user_id + word 唯一） | level, next_review_at, last_seen_at, wrong_count, correct_streak |
| `sessions` | 学习记录 | date, new_count, review_count, spelling_accuracy, level_ups, duration_seconds, hardest_word |
| `user_settings` | 用户设置 | daily_new, review_cap, relapse_cap, tts_enabled, tts_rate, daily_gen_count, last_gen_date |

### 10.2 导入导出
- 导出 JSON：包含 user_word_state、sessions、custom_wordlists、custom_words、user_settings
- 导入 JSON：按表 upsert（word_state 按 user_id+word 合并，词表新建导入）

---

## 11. 安全与权限

### 11.1 Row Level Security (RLS)
所有用户级表均启用 RLS，策略为 `auth.uid() = user_id`：
- `user_word_state`：用户只能读写自己的学习进度
- `sessions`：用户只能读写自己的学习记录
- `user_settings`：用户只能读写自己的设置
- `custom_wordlists`：用户只能管理自己的自定义词表
- `custom_words`：用户只能管理自己的自定义词汇

内置词表（`built_in_wordlists`、`built_in_words`）对所有认证用户只读。

### 11.2 认证
- Supabase Auth（邮箱 + 密码）
- 登录强制：未登录时自动跳转登录页
- Token 自动刷新 + 持久化会话

---

## 12. UI/UX 设计

### 12.1 视觉风格
- 移动端优先（max-width: 480px 居中布局）
- Inter 字体（Google Fonts）
- 主色调：Indigo（#6366f1）
- 支持系统级暗色模式（`prefers-color-scheme: dark`）
- 卡片式布局 + 柔和阴影 + 圆角

### 12.2 交互
- 按钮点击有缩放反馈
- 卡片切换有淡入动画
- 拼写正确/错误有色彩反馈
- 学习完成有庆祝动画（🎉 弹入）

---

## 13. 风险与对策
- 生成内容质量波动：提供编辑入口 + DeepSeek 兜底默认值
- 多义词困扰：默认保留常用义项 ≤ 3
- 坚持难：任务上限 + 当天回流上限 + 战报强化正反馈
- 网络依赖：需联网使用，断网时操作将失败（显示错误提示）
- API 安全：开发阶段 Key 在前端，公开部署时须切换为 Edge Function 代理

---

## 14. 验收标准（V1）
1. 外研版词表可浏览（按册→单元→词），能生成每日任务
2. 添加生词仅输入英文即可生成中文释义/音标/例句，且可编辑并保存
3. 学习过程无选择题：意思回想+自评，拼写必须打字
4. 拼写错误必须提示正确答案并至少纠正一次，且进入当天回流
5. SRS 生效：next_review 随表现正确变化
6. 新学完成后自动发起一轮复习，体验与到期复习一致
7. 今日战报与进度页数据正确
8. 多设备同步：同一账号在不同浏览器登录后数据一致
9. 支持数据导出/导入（JSON）
10. 移动端体验良好，支持内网手机访问

---

## 15. 附录

### 15.1 CSV 导入模板
```csv
word,meaning_cn,unit,example
apple,苹果,Unit 1,This is an apple.
go,去;走,Unit 1,Let's go to school.
```

### 15.2 项目目录结构
```
word-builder2/
├── src/
│   ├── main.jsx, App.jsx
│   ├── index.css
│   ├── lib/          (supabase, deepseek, tts)
│   ├── stores/       (authStore, settingsStore, studyStore)
│   ├── utils/        (srs, taskEngine, constants)
│   ├── pages/        (Login, Today, Study, Wordlist, Progress, Settings)
│   └── components/   (Layout/, Study/)
├── supabase/
│   ├── migration.sql
│   ├── import_grade7a.sql, import_grade7b.sql
│   └── functions/deepseek-proxy/  (公开部署用)
└── .env
```